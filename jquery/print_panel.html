<script type="text/javascript">
$('button[name="print"]').click(function(event) {
    event.preventDefault();
    
    var params = getParams();
    $.ajax({
        url: '/author33/services/print.php',
        type: 'POST',
        data: params,
        dataType: 'json',
        success: function(response) {
            if(typeof(response.result) != 'undefined' && response.result == 'ok') {
                $('#mapimage_dialog div.loading').hide();
                $('#mapimage_dialog hr').next().remove();
                var link = '<a href="'+response.file+'" target="_blank" rel="file">';
                if(response.format == 'HTML') {
                    link += OpenLayers.i18n('View print file');
                } else if(response.format == 'PDF') {
                    link += OpenLayers.i18n('Download print file');
                } else if(response.format == 'geotiff') {
                    link += OpenLayers.i18n('Download image');
                }
                link += '</a>';
                $('#mapimage_dialog div.results span[name="result"]').html(link);
                $('#mapimage_dialog div.results').show();
            } else alert(OpenLayers.i18n('Error'));
        },
        error: function() {
            alert(OpenLayers.i18n('Error'));
        }
    });
    
});

$('button[name="restart"]').click(function(event) {
    $('#mapimage_dialog div.results').hide();
    $('#mapimage_dialog div.loading').hide();
    $('#mapimage_dialog div.settings').show();
});

function getParams() {
    var self = this;
    
    $('#mapimage_dialog div.results').hide();
    $('#mapimage_dialog div.loading').show();
    $('#mapimage_dialog div.settings').hide();
    
    var params = getConfigParams();
    
    var tiles = [];
    
    $.each(GisClientMap.map.layers, function(key, layer) {
        if (!layer.getVisibility()) return;
        //if (!layer.calculateInRange()) return;
        var tile;
        if(layer.CLASS_NAME == 'OpenLayers.Layer.TMS') {
            tile = {
                url: layer.url.replace('/tms/', '/wms/'),
                parameters: {
                    service: 'WMS',
                    request: 'GetMap',
                    project: gisclient.getProject(),
                    map: gisclient.getMapOptions().mapsetName,
                    layers: [layer.layername.substr(0, layer.layername.indexOf('@'))],
                    version: '1.1.1',
                    format: 'image/png'
                },
                opacity: layer.opacity ? (layer.opacity * 100) : 100
            };
        } else if(layer.CLASS_NAME == 'OpenLayers.Layer.WMS') {
            tile = {
                url: layer.url,
                parameters: layer.params,
                opacity: layer.opacity ? (layer.opacity * 100) : 100
            };
        }
        if(tile) {
            if(layer.options.theme_id) {
                tile.options = {
                    theme_id: layer.options.theme_id,
                    theme_title: layer.options.theme_title || ''
                };
            }
            tiles.push(tile);
        }
    });

    if($('#mapimage_dialog input[name="legend"]:checked').val() == 'yes') {
        params.legend = 'yes';
        
        /*var themes = [];
        var themesMap = {};
        
        $.each(GisClientMap.map.layers, function(key, layer) {
            if (!layer.getVisibility()) return;
            
            if(layer.CLASS_NAME == 'OpenLayers.Layer.WMS') {
                if(!themesMap[layer.options.theme]) {
                    var theme = {
                        title: layer.theme,
                        id: layer.theme_id,
                        groups: []
                    };
                    var index = (themes.push(theme) - 1);
                    themesMap[theme.id] = index;
                } else {
                    var theme = themes[themesMap[layer.theme]];
                }
                
                var layers = layer.params && layer.params.LAYERS ? layer.params.LAYERS.slice(0) : [layer.name];
                
                $.each(layers, function(e, layerName) {
                    var group = {
                        title: layer.options.title,
                        id: layerName,
                        layers: [layerName]
                    };
                    theme.groups.push(group);
                });
            }
        });
        params.legend = {themes: themes};*/
    }
    /*var mapOptions = gisclient.getMapOptions();
    if(mapOptions.legend) {
        var gcLayersManager = gisclient.componentObjects.gcLayersManager;
        var printLegend = {mapsetUrl:gisclient.options.mapsetURL,themes:[]};
        var themes = gcLayersManager.getThemes();
        $.each(themes, function(themeId, theme) {
            if(!gcLayersManager.themeIsActive(themeId)) return;
            var themeObj = {title:theme.title, id:themeId, groups:[]};
            $.each(gcLayersManager.getLayers(themeId), function(groupId, group) {
                if(!gcLayersManager.layerIsActive(themeId, groupId)) return;
                if(typeof(group.legend) == 'undefined') return;
                var groupObj = {title:group.title, id:groupId, map:themeId, project:gisclient.getProject(), layers:[]};
                if(typeof(group.parameters) == 'object' && typeof(group.parameters.sld) != 'undefined') {
                    groupObj.sld = group.parameters.sld;
                }
                var url = mapOptions.mapsetURL+'legend/'+gisclient.getProject()+'/'+themeId+'-'+groupId+'.png';
                $.each(group.legend, function(e, layerName) {
                    var legendObj = {url:url, title:layerName.class_title};
                    groupObj.layers.push(legendObj);
                });
                themeObj.groups.push(groupObj);
            });
            printLegend.themes.push(themeObj);
        });
    }*/
    
    params.tiles = tiles;


    return params;
    
};

function getConfigParams() {
    var self = this;
    
    var size  = GisClientMap.map.getCurrentSize();
    var bounds = GisClientMap.map.calculateBounds();
    var topLeft = new OpenLayers.Geometry.Point(bounds.top, bounds.left);
    var topRight = new OpenLayers.Geometry.Point(bounds.top, bounds.right);
    var distance = topLeft.distanceTo(topRight);
    var pixelsDistance  = size.w / distance;
    var scaleMode = $('#mapimage_dialog input[name="scale_mode"]:checked').val();
    var scale = $('#mapimage_dialog input[name="scale"]').val();
    var currentScale = GisClientMap.map.getScale();
    if(scaleMode == 'user') {
        pixelsDistance = pixelsDistance / (scale/currentScale);
    }
    
    var center = GisClientMap.map.getCenter();
    
    
    var copyrightString = null;
    var searchControl = GisClientMap.map.getControlsByClass('OpenLayers.Control.Attribution');
    if(searchControl.length > 0) {
        copyrightString = searchControl[0].div.innerText;
    }
    
    var params = {
        viewport_size: [size.w, size.h],
        center: [center.lon, center.lat],
        format: $('#mapimage_dialog input[name="format"]:checked').val(),
        printFormat: $('#mapimage_dialog select[name="formato"]').val(),
        direction: $('#mapimage_dialog input[name="direction"]:checked').val(),
        scale_mode: scaleMode,
        scale: scale,
        current_scale: currentScale,
        text: $('#mapimage_dialog textarea[name="text"]').val(),
        extent: GisClientMap.map.calculateBounds().toBBOX(),
        date: $('#mapimage_dialog input[name="date"]').val(),
        dpi: $('#mapimage_dialog select[name="dpi"]').val(),
        srid: GisClientMap.map.getProjection(),
        pixels_distance: pixelsDistance,
        copyrightString: copyrightString
    };
    return params;
    
};
</script>
<div id="mapimage_dialog">
    <div class="settings">
        <fieldset data-tool="print">
            <legend data-text="information">Intestazioni stampa</legend>
            <div class="noflow" data-tool="print">
                <label>Testo:</label>
                <textarea name="text"></textarea>
            </div>
            <div class="noflow" data-tool="print">
                <label>Data:</label>
                <input type="text" name="date" style="width:82px;">
            </div>
        </fieldset>
        <fieldset data-tool="print">
            <legend>Propriet√† stampa:</legend>
            <div class="noflow" data-tool="print">
                <label>Legenda:</label>
                <div class="radio_container">
                    <input class="radio" type="radio" name="legend" id="legend_yes" value="yes">
                    <label for="legend_yes">Si</label>
                    <input class="radio" type="radio" name="legend" id="legend_no" value="no" checked="">
                    <label for="legend_no">No</label>
                </div>
            </div>
            <div class="noflow">
                <label>Layout di stampa:</label>
                <div class="radio_container">
                    <input class="radio" type="radio" name="direction" id="direction_v" value="vertical" checked=""> 
                    <label for="direction_v">Verticale</label>
                    <br>
                    <input class="radio" type="radio" name="direction" id="direction_h" value="horizontal">
                    <label for="direction_h">Orizzontale</label>
                </div>
            </div>
            <div class="noflow" data-role="print-formats">
                <label>Formato di stampa:</label>
                <div class="radio_container">
                    <select name="formato" style="width:auto;">
                        <option value="A4">A4</option>
                        <option value="A3">A3</option>
                    </select>
                </div>
            </div>
            <div class="noflow">
                <label>Formato:</label>
                <div class="radio_container">
                    <input class="radio" type="radio" name="format" id="format_HTML" value="HTML" checked="">
                    <label for="format_HTML">HTML</label>
                    <input class="radio" type="radio" name="format" id="format_PDF" value="PDF">
                    <label for="format_PDF">PDF</label>
                </div>
            </div>
        </fieldset>
        <fieldset>
            <legend>Opzioni</legend>
            <div class="noflow">
                <label>Scala:</label>
                <div class="radio_container">
                    <input class="radio" type="radio" name="scale_mode" id="scale_mode_auto" value="auto" checked="">
                    <label for="scale_mode_auto">Auto</label>
                    <br>
                    <input class="radio" type="radio" name="scale_mode" id="scale_mode_user" value="user"> <label for="scale_mode_user">1: </label>
                    <input type="text" name="scale" style="width:70px;" disabled="disabled">
                </div>
            </div>
            <div class="noflow" data-role="resolutions">
                <label>Risoluzione:</label>
                <select name="dpi" style="width:auto;">
                    <option value="96">Media</option>
                    <option value="150">Alta</option>
                </select>
            </div>
        </fieldset>
        <div class="buttons">
            <button name="print" data-tool="print">Stampa</button>
        </div>
    </div>
    <div class="results" style="display: none;">
        <span name="result"></span>
        <div class="buttons">
            <button name="restart">Ricomincia</button>
        </div>
    </div>
</div>