<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>testlayout</title>

  <link rel="stylesheet" href="../resources/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="../resources/themes/openlayers/style.css" type="text/css">

  <script type="text/javascript" src="../resources/jslib/jquery.min.js"></script>
  <script type="text/javascript" src="../resources/jslib/jquery.easyui.min.js"></script>
  <script type="text/javascript" src="../resources/external/typeahead/typeahead.bundle.js"></script>
  <link rel="stylesheet" type="text/css" href="../resources/themes/black/tree.css">


    <script src="../resources/jslib/OpenLayers.js"></script>
    <script src="../resources/jslib/gcOloverride.js"></script>    
    <script src="../resources/jslib/QueryMap.js"></script>
    <script src="../resources/jslib/GisClientMap.js"></script>   
  <script src="../resources/jslib/LayerTree.js"></script>
    <script src="../resources/jslib/LoadingPanel.js"></script>
    <script src="../resources/jslib/PrintMap.js"></script>
    <script src="../resources/jslib/PipeSelect.js"></script>
    <script src="../resources/jslib/DynamicMeasure.js"></script>

    <script src="../resources/jslib/QueryToolbar.js"></script>   



    <script src="mobile.js" type="text/javascript"></script>

   <script src="../resources/jslib/bootstrap.min.js"></script>



    <script type="text/javascript" src="../resources/jslib/ole/loader.js"></script>
    <link rel="stylesheet" href="../resources/themes/ole/geosilk.css" type="text/css" />



	<script type="text/javascript">


    function testpanel(fileToLoad){


        if($(".gisclient-toolbar-container").hasClass("open")){
            $(".gisclient-toolbar-container").animate({
                width:'45px'
              });
            $(".gisclient-toolbar-container").removeClass("open")
        }
        else{
            $(".gisclient-toolbar-container").animate({
                width:'320px'
              });
            $(".gisclient-toolbar-container").addClass("open");
            if(fileToLoad) {
                $( "#mypanel" ).load(fileToLoad);
            }
        }

    }


    function test3(){
        if(mycontrol.active)
          mycontrol.deactivate()
        else
          mycontrol.activate()

    }


    function ricerca(){

        var selectedFeatureType = $('select.olControlQueryMapSelect').val();
        if(selectedFeatureType == OpenLayers.GisClient.queryToolbar.VISIBLE_LAYERS ||
            selectedFeatureType == OpenLayers.GisClient.queryToolbar.ALL_LAYERS) {
            return alert('Seleziona un livello prima');
        }
        
        var featureTypes = GisClientMap.featureTypes,
            len = featureTypes.length, fType, i,
            form = '';
         
        for(i = 0; i < len; i++) {
            if(featureTypes[i].typeName == selectedFeatureType) {
                fType = featureTypes[i];
                break;
            }
        }
        
        if(!fType) return alert('Errore: il featureType '+selectedFeatureType+' non esiste');
        
        var form = '',
            properties = fType.properties, 
            len = properties.length, property, i;
        
        form += '<p>Ricerca '+fType.title+'</p>'+
            '<form role="form">';
        
        for(i = 0; i < len; i++) {
            property = properties[i];
            
            if(!property.searchType) continue; //searchType undefined oppure 0
            
            form += '<div class="form-group">'+
                        '<label for="search_form_input_'+i+'">'+property.header+'</label>';
            
            switch(property.searchType) {
                case 1:
                case 2: //testo
                    form += '<input type="text" name="'+property.name+'" searchType="'+property.searchType+'" class="form-control" id="search_form_input_'+i+'">';
                break;
                case 3: //lista di valori
                    form += '<input type="text" name="'+property.name+'" fieldId="'+property.fieldId+'" searchType="'+property.searchType+'" class="form-control typeahead" id="search_form_input_'+i+'">';
                break;
                case 4: //numero
                    form += '<div class="form-inline">'+
                        '<select name="'+property.name+'_operator" class="form-control">'+
                        '<option value="'+OpenLayers.Filter.Comparison.EQUAL_TO+'">=</option>'+
                        '<option value="'+OpenLayers.Filter.Comparison.NOT_EQUAL_TO+'">!=</option>'+
                        '<option value="'+OpenLayers.Filter.Comparison.LESS_THAN+'">&lt;</option>'+
                        '<option value="'+OpenLayers.Filter.Comparison.GREATER_THAN+'">&gt;</option>'+
                        '</select>'+
                        '<input type="number" name="'+property.name+'" searchType="'+property.searchType+'" class="form-control" id="search_form_input_'+i+'">'+
                        '</div>';
                break;
                case 5: //data
                    form += '<input type="date" name="'+property.name+'" searchType="'+property.searchType+'" class="form-control" id="search_form_input_'+i+'">';
                break;
                case 6: //lista di valori non wfs
                    form += '<input type="number" name="'+property.name+'" searchType="'+property.searchType+'" class="form-control" id="search_form_input_'+i+'">';
                break;
            }
            
            form += '</div>';
        }
        
        form += '<div class="form-group"><input type="checkbox" name="use_current_extent" gcfilter="false"> Filtra sull\'extent attuale</div>'+
            '<button type="submit" class="btn btn-default">Cerca</button>'+
            '</form>';
        
        $('#ricerca').empty().append(form);
        
        $('#ricerca input.typeahead').each(function(e, input) {
            var fieldId = $(input).attr('fieldId');
            
            $(input).typeahead({
                minLength: 2
            },{
                source: function(query, process) {
                    return $.ajax({
                        url: '/gisclient/services/xSuggest.php',
                        data: {
                            suggest: query,
                            field_id: fieldId
                        },
                        dataType: 'json',
                        success: function(data) {
                            return process(data.data);
                        }
                    });
                }
            });
        });
        
        $('#ricerca button[type="submit"]').click(function(event) {
            event.preventDefault();
            
            var filters = [];
            $('#ricerca form input[gcfilter!="false"]').each(function(e, input) {
                var name = $(input).attr('name'),
                    value = $(input).val(),
                    searchType = $(input).attr('searchType'),
                    type = OpenLayers.Filter.Comparison.EQUAL_TO;
                
                if(!value || value == '') return;
                
                if(searchType == 4) {
                    type = $('#ricerca form input[name="'+name+'_operator"]').val();
                }
                if(searchType == 2) {
                    type = OpenLayers.Filter.Comparison.LIKE;
                    value = '%'+value+'%';
                }
                
                filters.push(new OpenLayers.Filter.Comparison({
                    type: type,
                    property: name,
                    value: value
                }));
                
            });
            
            if(filters.length == 0) return alert('Specificare almeno un parametro di ricerca');
            
            var geometry;
            if($('#ricerca input[name="use_current_extent"]').prop('checked')) {
                geometry = GisClientMap.map.getExtent();
            } else {
                geometry = GisClientMap.map.getMaxExtent();
            }
            
            var filter = new OpenLayers.Filter.Logical({
                type: OpenLayers.Filter.Logical.AND,
                filters: filters
            });
            
            var control = GisClientMap.map.getControlsByClass('OpenLayers.Control.QueryMap')[0];
            var oldQueryFilters = control.queryFilters[fType.typeName];
            control.queryFilters[fType.typeName] = filter;
            var oldHighlight = control.highLight;
            control.highLight = true;
            
            control.select(geometry);
            
            control.queryFilters[fType.typeName] = oldQueryFilters;
            control.highLight = oldHighlight;
            //control.select -> non va molto bene, ci sono delle opzioni settate all'inizio (queryFilters, highlight, targets) che dovrei sovrascrivere qui...
            //impostarli e poi toglierli
            
            
            //var layer = control.getLayerFromFeature(fType.typeName);
            //control.getFeatures(layer, fType, filter);
            //FD: aprire il tab dei risultati di ricerca -> usare gli eventi
            // vedere come fare per l'highlight

        });
    
        //$('#myModal').modal({remote:'test_table.html'});
        $('#SearchWindow').modal('show');
    


    }




</script>


    <script src="../resources/jslib/json2.js" type="text/javascript"></script>



  <link rel="stylesheet" href="header.css" type="text/css">
  <link rel="stylesheet" href="toolbars.css" type="text/css">
  <link rel="stylesheet" href="sidebar.css" type="text/css">
  <link rel="stylesheet" href="../resources/external/typeahead/typeahead.css" type="text/css">

  <script src="../resources/external/knockout-query-builder/js/vendor/knockout-2.2.1.js"></script>
  <script src="../resources/external/knockout-query-builder/js/condition.js"></script>
  <script src="../resources/external/knockout-query-builder/js/group.js"></script>
  <script src="../resources/external/knockout-query-builder/js/viewModel.js"></script>
  
  <link rel="stylesheet" href="../resources/external/knockout-query-builder/css/styles.css" type="text/css">
  
  
</head>
<body class="map-layout">
<!--  <header>

    <h1> intestazione...... </h1>

  </header>
-->

  <div id="content">
    <div id="map"></div>
    <div id="map-toolbars">

      <div id="map-toolbar-query" class="olToolbarsControl"></div>
      <div id="map-toolbar-measure" class="olToolbarsControl"></div>
      <div id="map-toolbar-redline" class="olToolbarsControl"></div>
      <div id="map-toolbar-tools" class="olToolbarsControl"></div>
    </div>

    <div id="map-overlay-panel">
      <div id="map-sidebar"></div>
      <div id="sidebar-panel">
        <div class="panel-header"><div class="panel-title">Pannello di dx </div><div class="panel-close">chiudi X</div></div>
        <div id="layertree" style="display:none"></div>
        <div id="resultpanel" style="display:none"></div>
        <div id="printpanel" style="display:none">
        </div>
      </div>
      <div id="sidebar-drag"></div>
    </div>
  </div>



<!-- Modal -->

<div id="SearchWindow" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h4 class="modal-title">Ricerca ...... modello di ricerca</h4>
    </div>
    <div class="modal-body">
           <!-- Nav tabs -->
      <ul class="nav nav-tabs">
        <li class="active"><a href="#ricerca" data-toggle="tab">Ricerca</a></li>
        <li><a href="#avanzata" data-toggle="tab">Ricerca avanzata</a></li>
        <li><a href="#stile" data-toggle="tab">Stile</a></li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">
        <div class="tab-pane active" id="ricerca">

          Form di ricerca per il livello indicato

        </div>
        <div class="tab-pane" id="avanzata">
          <span> Form di ricerca avanzata per il livello indicato</span>
          <div class="query"></div>
          <button id="btnCondition">Condizione</button>
          <button id="btnQuery">Query</button>    

        </div>
        <div class="tab-pane" id="stile">


        </div>
      </div>
    </div>
    </div>
  </div>
</div>


<div id="map-footer">
  <select id="map-select-scale"><option>ELENCO DELLE SCALE</option></select>
  <span id="map-coordinates"></span>
  <span id="map-footer-info"></span>
</div>

</body>
</html>
