<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>testlayout</title>

  <link rel="stylesheet" href="../resources/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="../resources/themes/openlayers/style.css" type="text/css">

  <script type="text/javascript" src="../resources/jslib/jquery.min.js"></script>
  <script type="text/javascript" src="../resources/jslib/jquery.easyui.min.js"></script>
  <script type="text/javascript" src="../resources/external/typeahead/typeahead.bundle.js"></script>
  <link rel="stylesheet" type="text/css" href="../resources/themes/black/tree.css">


    <script src="../resources/jslib/OpenLayers.js"></script>
    <script src="../resources/jslib/gcOloverride.js"></script>    
    <script src="../resources/jslib/QueryMap.js"></script>
    <script src="../resources/jslib/GisClientMap.js"></script>   
  <script src="../resources/jslib/LayerTree.js"></script>
    <script src="../resources/jslib/LoadingPanel.js"></script>
    <script src="../resources/jslib/PrintMap.js"></script>
    <script src="../resources/jslib/PipeSelect.js"></script>
    <script src="../resources/jslib/DynamicMeasure.js"></script>

    <script src="../resources/jslib/QueryToolbar.js"></script>   



    <script src="mobile.js" type="text/javascript"></script>

   <script src="../resources/jslib/bootstrap.min.js"></script>



    <script type="text/javascript" src="../resources/jslib/ole/loader.js"></script>
    <link rel="stylesheet" href="../resources/themes/ole/geosilk.css" type="text/css" />



	<script type="text/javascript">


    function testpanel(fileToLoad){


        if($(".gisclient-toolbar-container").hasClass("open")){
            $(".gisclient-toolbar-container").animate({
                width:'45px'
              });
            $(".gisclient-toolbar-container").removeClass("open")
        }
        else{
            $(".gisclient-toolbar-container").animate({
                width:'320px'
              });
            $(".gisclient-toolbar-container").addClass("open");
            if(fileToLoad) {
                $( "#mypanel" ).load(fileToLoad);
            }
        }

    }


    function test3(){
        if(mycontrol.active)
          mycontrol.deactivate()
        else
          mycontrol.activate()

    }


    $(document).ready(function() {
    $('#btnAdvancedQuery').click(function(event) {
        console.log('advanced query click');
        event.preventDefault();
        
        var selectedFeatureType = $('select.olControlQueryMapSelect').val();
        
        //di questo si potrebbe fare una funzione in GisClientMap.js, tipo getFeatureTypeByName o qualcosa del genere..
        // lo stesso codice è anche nella parte dove viene gestito il link per visualizzare i dati 1n
        var featureTypes = GisClientMap.featureTypes,
            len = featureTypes.length, fType, i,
            form = '';
         
        for(i = 0; i < len; i++) {
            if(featureTypes[i].typeName == selectedFeatureType) {
                fType = featureTypes[i];
                break;
            }
        }
        
        if(!fType) return alert('Errore: il featureType '+selectedFeatureType+' non esiste');
        
        var queryMap = GisClientMap.map.getControlsByClass('OpenLayers.Control.QueryMap')[0];
		queryMap.resultLayer.removeAllFeatures();
		queryMap.events.triggerEvent('startQueryMap');
        
        var params = ConditionBuilder.getQuery();
        params.projectName = GisClientMap.projectName;
        params.mapsetName = GisClientMap.name;
        params.srid = GisClientMap.map.projection;
        params.featureType = selectedFeatureType;
        
        $.ajax({
            url: '/gisclient/services/xMapQuery.php',
            method: 'POST',
            dataType: 'json',
            data: params,
            success: function(response) {
                if(!response || typeof(response) != 'object') {
                    return alert('Errore di sistema');
                }
                if(!response.length) {
                    return alert('Nessun risultato');
                }
                
                var features = [],
                    len = response.length, result, i, geometry;
                
                for(i = 0; i < len; i++) {
                    result = response[i];
                    
                    geometry = result.gc_geom && OpenLayers.Geometry.fromWKT(result.gc_geom);
                    if(!geometry) continue;
                    delete result.gc_geom;
                    
                    features.push(new OpenLayers.Feature.Vector(geometry, result));
                }
                
				fType.features = features;
				queryMap.events.triggerEvent('featuresLoaded',fType);
                queryMap.resultLayer.addFeatures(features);
                queryMap.events.triggerEvent('endQueryMap');
                $('#SearchWindow').modal('hide');
                $("#resultpanel").addClass("smalltable"); //non so perchè l'ho dovuto mettere qui....
            },
            error: function() {
                alert('Errore di sistema');
            }
        });
        
    });
    
    setTimeout(function() { //soluzione super-temporanea, tanto questo va spostato da qui...
    var queryToolbar = GisClientMap.map.getControlsByClass('OpenLayers.GisClient.queryToolbar')[0];
    queryToolbar.events.register('viewdetailsclick', null, function(event) {
        var featureTypes = GisClientMap.featureTypes,
            feature = event.feature,
            len = featureTypes.length, fType, i,
            form = '';
        
        if(!feature) return console.log('Feature undefined');
        
        for(i = 0; i < len; i++) {
            if(featureTypes[i].typeName == event.featureType) {
                fType = featureTypes[i];
                break;
            }
        }
        
        if(!fType) return alert('Errore: il featureType '+event.featureType+' non esiste');
        
        var len = fType.properties.length, property, i,
            pkey;

        for(i = 0; i < len; i++) {
            property = fType.properties[i];
            
            if(property.isPrimaryKey) {
                pkey = property.name;
                break;
            }
        }
        
        if(!pkey) {
            return alert('Errore: la primary key non è tra i campi del layer, impossibile visualizzare i dati collegati');
        }
        
        if(!feature.attributes[pkey]) {
            return alert('Errore: la feature selezionata non ha un valore per la primary key '+pkey);
        }
        
        var params = {
            projectName: GisClientMap.projectName,
            mapsetName: GisClientMap.name,
            srid: GisClientMap.map.projection,
            featureType: event.featureType,
            featureId: feature.attributes[pkey],
            action: 'viewdetails'
        };
        
        $.ajax({
            url: '/gisclient/services/xMapQuery.php',
            method: 'POST',
            dataType: 'json',
            data: params,
            success: function(response) {
                console.log('success', response);
            }
        });
        
        
        console.log(fType, feature);
    });
    }, 5000);
    
    
    });




</script>
   
    
<script src="../resources/jslib/ConditionBuilder.js" type="text/javascript"></script>


  <link rel="stylesheet" href="header.css" type="text/css">
  <link rel="stylesheet" href="toolbars.css" type="text/css">
  <link rel="stylesheet" href="sidebar.css" type="text/css">
  <link rel="stylesheet" href="../resources/external/typeahead/typeahead.css" type="text/css">
  
  <style>
  #map-overlay-panel {z-index: 10000}
  </style>
  
  
</head>
<body class="map-layout">
<!--  <header>

    <h1> intestazione...... </h1>

  </header>
-->

  <div id="content">
    <div id="map"></div>
    <div id="map-toolbars">

      <div id="map-toolbar-query" class="olToolbarsControl"></div>
      <div id="map-toolbar-measure" class="olToolbarsControl"></div>
      <div id="map-toolbar-redline" class="olToolbarsControl"></div>
      <div id="map-toolbar-tools" class="olToolbarsControl"></div>
    </div>

    <div id="map-overlay-panel">
      <div id="map-sidebar"></div>
      <div id="sidebar-panel">
        <div class="panel-header"><div class="panel-title">Pannello di dx </div><div class="panel-close">chiudi X</div></div>
        <div id="layertree" style="display:none"></div>
        <div id="resultpanel" style="display:none"></div>
        <div id="printpanel" style="display:none">
        </div>
      </div>
      <div id="sidebar-drag"></div>
    </div>
  </div>



<!-- Modal -->

<div id="SearchWindow" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h4 class="modal-title" id="searchFormTitle">Ricerca</h4>
    </div>
    <div class="modal-body" style="overflow:auto;">
           <!-- Nav tabs -->
      <ul class="nav nav-tabs">
        <li class="active"><a href="#ricerca" data-toggle="tab">Ricerca</a></li>
        <li><a href="#avanzata" data-toggle="tab">Ricerca avanzata</a></li>
        <!--<li><a href="#stile" data-toggle="tab">Stile</a></li>-->
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">
        <div class="tab-pane active" id="ricerca">

          Form di ricerca per il livello indicato

        </div>
        <div class="tab-pane" id="avanzata">
          <span> Form di ricerca avanzata per il livello indicato</span>
          <div class="query"></div>
          <button id="btnAdvancedQuery">Query</button>    

        </div>
        <div class="tab-pane" id="stile">


        </div>
      </div>
    </div>
    </div>
  </div>
</div>


<div id="map-footer">
  <select id="map-select-scale"><option>ELENCO DELLE SCALE</option></select>
  <span id="map-coordinates"></span>
  <span id="map-footer-info"></span>
</div>

</body>
</html>
